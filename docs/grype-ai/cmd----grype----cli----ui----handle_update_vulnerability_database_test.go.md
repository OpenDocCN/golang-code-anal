# `grype\cmd\grype\cli\ui\handle_update_vulnerability_database_test.go`

```
package ui

import (
    "testing"  // 导入测试包
    "time"  // 导入时间包

    tea "github.com/charmbracelet/bubbletea"  // 导入 bubbletea 包
    "github.com/gkampitakis/go-snaps/snaps"  // 导入 go-snaps 包
    "github.com/stretchr/testify/require"  // 导入 testify 包
    "github.com/wagoodman/go-partybus"  // 导入 go-partybus 包
    "github.com/wagoodman/go-progress"  // 导入 go-progress 包

    "github.com/anchore/bubbly/bubbles/taskprogress"  // 导入 taskprogress 包
    "github.com/anchore/grype/grype/event"  // 导入 event 包
)

func TestHandler_handleUpdateVulnerabilityDatabase(t *testing.T) {
    // 定义测试用例
    tests := []struct {
        name       string  // 测试用例名称
        eventFn    func(*testing.T) partybus.Event  // 事件处理函数
        iterations int  // 迭代次数
    }{
        {
            name: "downloading DB",  // 测试用例名称
            eventFn: func(t *testing.T) partybus.Event {  // 事件处理函数
                prog := &progress.Manual{}  // 创建 Manual 进度条对象
                prog.SetTotal(100)  // 设置总进度为 100
                prog.Set(50)  // 设置当前进度为 50

                mon := struct {  // 创建结构体 mon
                    progress.Progressable  // 包含进度接口
                    progress.Stager  // 包含阶段接口
                }{
                    Progressable: prog,  // 设置进度条对象
                    Stager: &progress.Stage{  // 设置阶段对象
                        Current: "current",  // 当前阶段为 "current"
                    },
                }

                return partybus.Event{  // 返回事件对象
                    Type:  event.UpdateVulnerabilityDatabase,  // 事件类型为更新漏洞数据库
                    Value: mon,  // 事件值为 mon
                }
            },
        },
        {
            name: "DB download complete",  // 测试用例名称
            eventFn: func(t *testing.T) partybus.Event {  // 事件处理函数
                prog := &progress.Manual{}  // 创建 Manual 进度条对象
                prog.SetTotal(100)  // 设置总进度为 100
                prog.Set(100)  // 设置当前进度为 100
                prog.SetCompleted()  // 标记为已完成

                mon := struct {  // 创建结构体 mon
                    progress.Progressable  // 包含进度接口
                    progress.Stager  // 包含阶段接口
                }{
                    Progressable: prog,  // 设置进度条对象
                    Stager: &progress.Stage{  // 设置阶段对象
                        Current: "current",  // 当前阶段为 "current"
                    },
                }

                return partybus.Event{  // 返回事件对象
                    Type:  event.UpdateVulnerabilityDatabase,  // 事件类型为更新漏洞数据库
                    Value: mon,  // 事件值为 mon
                }
            },
        },
    }
    for _, tt := range tests {
        // 遍历测试用例切片
        t.Run(tt.name, func(t *testing.T) {
            // 运行子测试，并使用测试用例的名称作为子测试的名称
            e := tt.eventFn(t)
            // 调用事件函数，获取事件对象
            handler := New(DefaultHandlerConfig())
            // 创建一个新的处理程序实例
            handler.WindowSize = tea.WindowSizeMsg{
                Width:  100,
                Height: 80,
            }
            // 设置处理程序的窗口大小

            models, _ := handler.Handle(e)
            // 使用处理程序处理事件，获取模型切片
            require.Len(t, models, 1)
            // 断言模型切片的长度为1
            model := models[0]
            // 获取第一个模型

            tsk, ok := model.(taskprogress.Model)
            // 尝试将模型转换为任务进度模型
            require.True(t, ok)
            // 断言转换是否成功

            got := runModel(t, tsk, tt.iterations, taskprogress.TickMsg{
                Time:     time.Now(),
                Sequence: tsk.Sequence(),
                ID:       tsk.ID(),
            })
            // 运行模型，获取结果
            t.Log(got)
            // 记录结果日志
            snaps.MatchSnapshot(t, got)
            // 使用快照断言库匹配结果
        })
    }
# 闭合前面的函数定义
```