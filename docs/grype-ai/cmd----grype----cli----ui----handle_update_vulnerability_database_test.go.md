# `grype\cmd\grype\cli\ui\handle_update_vulnerability_database_test.go`

```
package ui

import (
	"testing"  // 导入测试包
	"time"  // 导入时间包

	tea "github.com/charmbracelet/bubbletea"  // 导入 bubbletea 包
	"github.com/gkampitakis/go-snaps/snaps"  // 导入 go-snaps 包
	"github.com/stretchr/testify/require"  // 导入 testify 包
	"github.com/wagoodman/go-partybus"  // 导入 go-partybus 包
	"github.com/wagoodman/go-progress"  // 导入 go-progress 包

	"github.com/anchore/bubbly/bubbles/taskprogress"  // 导入 taskprogress 包
	"github.com/anchore/grype/grype/event"  // 导入 event 包
)

func TestHandler_handleUpdateVulnerabilityDatabase(t *testing.T) {
	// 定义测试用例
	tests := []struct {
		name       string  // 测试用例名称
		eventFn    func(*testing.T) partybus.Event  // 定义一个函数类型的变量eventFn，用于存储测试事件的函数
		iterations int  // 定义一个整型变量iterations，用于存储迭代次数
	}{
		{
			name: "downloading DB",  // 设置事件名称为"downloading DB"
			eventFn: func(t *testing.T) partybus.Event {  // 定义一个匿名函数，用于生成测试事件
				prog := &progress.Manual{}  // 创建一个progress.Manual类型的对象prog
				prog.SetTotal(100)  // 设置prog的总进度为100
				prog.Set(50)  // 设置prog的当前进度为50

				mon := struct {  // 创建一个匿名结构体mon
					progress.Progressable  // 匿名字段，表示mon具有progress.Progressable的属性和方法
					progress.Stager  // 匿名字段，表示mon具有progress.Stager的属性和方法
				}{
					Progressable: prog,  // 将prog赋值给Progressable字段
					Stager: &progress.Stage{  // 创建一个progress.Stage类型的对象，并赋值给Stager字段
						Current: "current",  // 设置progress.Stage对象的Current属性为"current"
					},
				}
# 返回一个事件对象，类型为更新漏洞数据库，值为mon
return partybus.Event{
    Type:  event.UpdateVulnerabilityDatabase,
    Value: mon,
}
```
```
# 创建一个名为"DB download complete"的事件对象
{
    name: "DB download complete",
    # 定义一个匿名函数，返回一个事件对象
    eventFn: func(t *testing.T) partybus.Event {
        # 创建一个手动进度对象
        prog := &progress.Manual{}
        # 设置总进度为100
        prog.SetTotal(100)
        # 设置当前进度为100
        prog.Set(100)
        # 标记进度为已完成
        prog.SetCompleted()

        # 创建一个结构体，包含进度和阶段信息
        mon := struct {
            progress.Progressable
            progress.Stager
        }{
            Progressable: prog,
            Stager: &progress.Stage{
# 创建一个包含事件类型和值的partybus.Event对象
return partybus.Event{
    Type:  event.UpdateVulnerabilityDatabase,  # 设置事件类型为更新漏洞数据库
    Value: mon,  # 设置事件值为mon
}

# 遍历测试用例，对每个测试用例运行对应的事件函数
for _, tt := range tests {
    t.Run(tt.name, func(t *testing.T) {
        e := tt.eventFn(t)  # 调用测试用例的事件函数，获取事件对象
        handler := New(DefaultHandlerConfig())  # 创建一个新的处理程序
        handler.WindowSize = tea.WindowSizeMsg{  # 设置处理程序的窗口大小
            Width:  100,  # 设置窗口宽度为100
            Height: 80,  # 设置窗口高度为80
        }
# 调用 handler 的 Handle 方法处理事件 e，返回 models 和错误信息
models, _ := handler.Handle(e)
# 断言 models 的长度为 1
require.Len(t, models, 1)
# 取出 models 中的第一个元素
model := models[0]

# 将 model 转换为 taskprogress.Model 类型，同时判断转换是否成功
tsk, ok := model.(taskprogress.Model)
require.True(t, ok)

# 调用 runModel 方法，传入参数 t, tsk, tt.iterations, taskprogress.TickMsg 结构体
got := runModel(t, tsk, tt.iterations, taskprogress.TickMsg{
    Time:     time.Now(),
    Sequence: tsk.Sequence(),
    ID:       tsk.ID(),
})
# 打印 got 的值
t.Log(got)
# 使用 snaps 包的 MatchSnapshot 方法，比较 got 和预期结果，断言测试是否通过
snaps.MatchSnapshot(t, got)
```