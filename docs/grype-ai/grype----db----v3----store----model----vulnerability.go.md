# `grype\grype\db\v3\store\model\vulnerability.go`

```
package model

import (
    "encoding/json"
    "fmt"

    v3 "github.com/anchore/grype/grype/db/v3"
)

const (
    VulnerabilityTableName    = "vulnerability"  // 定义漏洞表的表名
    GetVulnerabilityIndexName = "get_vulnerability_index"  // 定义获取漏洞索引的名称
)

// VulnerabilityModel is a struct used to serialize db.Vulnerability information into a sqlite3 DB.
type VulnerabilityModel struct {
    PK                     uint64 `gorm:"primary_key;auto_increment;"`  // 定义主键
    ID                     string `gorm:"column:id"`  // 定义 ID 字段
    PackageName            string `gorm:"column:package_name; index:get_vulnerability_index"`  // 定义包名字段，并创建索引
    Namespace              string `gorm:"column:namespace; index:get_vulnerability_index"`  // 定义命名空间字段，并创建索引
    VersionConstraint      string `gorm:"column:version_constraint"`  // 定义版本约束字段
    VersionFormat          string `gorm:"column:version_format"`  // 定义版本格式字段
    CPEs                   string `gorm:"column:cpes"`  // 定义 CPEs 字段
    RelatedVulnerabilities string `gorm:"column:related_vulnerabilities"`  // 定义相关漏洞字段
    FixedInVersions        string `gorm:"column:fixed_in_versions"`  // 定义修复版本字段
    FixState               string `gorm:"column:fix_state"`  // 定义修复状态字段
    Advisories             string `gorm:"column:advisories"`  // 定义建议字段
}

// NewVulnerabilityModel generates a new model from a db.Vulnerability struct.
func NewVulnerabilityModel(vulnerability v3.Vulnerability) VulnerabilityModel {
    cpes, err := json.Marshal(vulnerability.CPEs)  // 将 CPEs 转换为 JSON 格式
    if err != nil {
        // 如果出现错误，抛出异常
        panic(err)
    }

    related, err := json.Marshal(vulnerability.RelatedVulnerabilities)  // 将相关漏洞信息转换为 JSON 格式
    if err != nil {
        // 如果出现错误，抛出异常
        panic(err)
    }

    advisories, err := json.Marshal(vulnerability.Advisories)  // 将建议信息转换为 JSON 格式
    if err != nil {
        // 如果出现错误，抛出异常
        panic(err)
    }

    fixedInVersions, err := json.Marshal(vulnerability.Fix.Versions)  // 将修复版本信息转换为 JSON 格式
    if err != nil {
        // 如果出现错误，抛出异常
        panic(err)
    }
    # 返回一个VulnerabilityModel对象，包含以下属性：
    # vulnerability.ID: 漏洞ID
    # vulnerability.PackageName: 包名
    # vulnerability.Namespace: 命名空间
    # vulnerability.VersionConstraint: 版本约束
    # vulnerability.VersionFormat: 版本格式
    # fixedInVersions: 修复版本
    # vulnerability.Fix.State: 修复状态
    # advisories: 建议
    # cpes: CPE（通用产品和版本）条目
    # related: 相关漏洞
// TableName 返回存储所有 db.Vulnerability 模型实例的表名。
func (VulnerabilityModel) TableName() string {
    return VulnerabilityTableName
}

// Inflate 从序列化的模型实例生成 db.Vulnerability 对象。
func (m *VulnerabilityModel) Inflate() (v3.Vulnerability, error) {
    var cpes []string
    err := json.Unmarshal([]byte(m.CPEs), &cpes)
    if err != nil {
        return v3.Vulnerability{}, fmt.Errorf("无法解析 CPEs (%+v): %w", m.CPEs, err)
    }

    var related []v3.VulnerabilityReference
    err = json.Unmarshal([]byte(m.RelatedVulnerabilities), &related)
    if err != nil {
        return v3.Vulnerability{}, fmt.Errorf("无法解析相关漏洞 (%+v): %w", m.RelatedVulnerabilities, err)
    }

    var advisories []v3.Advisory
    err = json.Unmarshal([]byte(m.Advisories), &advisories)
    if err != nil {
        return v3.Vulnerability{}, fmt.Errorf("无法解析建议 (%+v): %w", m.Advisories, err)
    }

    var versions []string
    err = json.Unmarshal([]byte(m.FixedInVersions), &versions)
    if err != nil {
        return v3.Vulnerability{}, fmt.Errorf("无法解析版本 (%+v): %w", m.FixedInVersions, err)
    }

    return v3.Vulnerability{
        ID:                     m.ID,
        PackageName:            m.PackageName,
        Namespace:              m.Namespace,
        VersionConstraint:      m.VersionConstraint,
        VersionFormat:          m.VersionFormat,
        CPEs:                   cpes,
        RelatedVulnerabilities: related,
        Fix: v3.Fix{
            Versions: versions,
            State:    v3.FixState(m.FixState),
        },
        Advisories: advisories,
    }, nil
}
```