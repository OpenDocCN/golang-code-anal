# `grype\grype\db\v1\store\model\vulnerability_metadata.go`

```
package model

import (
	"database/sql"  // 导入数据库操作相关的包
	"encoding/json" // 导入 JSON 编解码相关的包
	"fmt"           // 导入格式化输出相关的包

	v1 "github.com/anchore/grype/grype/db/v1" // 导入指定路径下的包

)

const (
	VulnerabilityMetadataTableName = "vulnerability_metadata" // 定义漏洞元数据表的表名常量
)

// VulnerabilityMetadataModel is a struct used to serialize db.VulnerabilityMetadata information into a sqlite3 DB.
type VulnerabilityMetadataModel struct {
	ID           string         `gorm:"primary_key; column:id;"` // 定义 ID 字段，指定为主键
	RecordSource string         `gorm:"primary_key; column:record_source;"` // 定义 RecordSource 字段，指定为主键
	Severity     string         `gorm:"column:severity"` // 定义 Severity 字段
	Links        string         `gorm:"column:links"` // 定义 Links 字段
```
// Description 是漏洞描述的字段
Description  string         `gorm:"column:description"`
// CvssV2 是 CVSS V2 的字段，使用 sql.NullString 类型
CvssV2       sql.NullString `gorm:"column:cvss_v2"`
// CvssV3 是 CVSS V3 的字段，使用 sql.NullString 类型
CvssV3       sql.NullString `gorm:"column:cvss_v3"`
}

// NewVulnerabilityMetadataModel 从 db.VulnerabilityMetadata 结构生成一个新的模型
func NewVulnerabilityMetadataModel(metadata v1.VulnerabilityMetadata) VulnerabilityMetadataModel {
	// 将 metadata.Links 转换为 JSON 字符串
	links, err := json.Marshal(metadata.Links)
	if err != nil {
		// 如果转换出错，抛出异常
		// TODO: just no
		panic(err)
	}

	// 初始化一个空的 CVSS V2 字符串
	var cvssV2Str sql.NullString
	// 如果 metadata.CvssV2 不为空
	if metadata.CvssV2 != nil {
		// 将 metadata.CvssV2 转换为 JSON 字符串
		cvssV2, err := json.Marshal(*metadata.CvssV2)
		if err != nil {
			// 如果转换出错，抛出异常
			// TODO: just no
			panic(err)
		}
		// 将 cvssV2 转换为字符串并赋值给 cvssV2Str
		cvssV2Str.String = string(cvssV2)
		// 设置 cvssV2Str 为有效值
		cvssV2Str.Valid = true
	}

	// 定义一个 sql.NullString 类型的变量 cvssV3Str
	var cvssV3Str sql.NullString
	// 如果 metadata.CvssV3 不为空
	if metadata.CvssV3 != nil {
		// 将 metadata.CvssV3 转换为 JSON 格式并赋值给 cvssV3
		cvssV3, err := json.Marshal(*metadata.CvssV3)
		// 如果转换过程中出现错误
		if err != nil {
			// 抛出异常并终止程序运行
			panic(err)
		}
		// 将 cvssV3 转换为字符串并赋值给 cvssV3Str
		cvssV3Str.String = string(cvssV3)
		// 设置 cvssV3Str 为有效值
		cvssV3Str.Valid = true
	}

	// 返回 VulnerabilityMetadataModel 结构体
	return VulnerabilityMetadataModel{
		// 设置 ID 字段值为 metadata.ID
		ID:           metadata.ID,
		// 设置 RecordSource 字段值为 metadata.RecordSource
		RecordSource: metadata.RecordSource,
		// 设置 Severity 字段值为 metadata.Severity
		Severity:     metadata.Severity,
		// 将 links 转换为字符串并设置为 Links 字段值
		Links:        string(links),
		Description:  metadata.Description, // 将metadata的Description字段赋值给当前对象的Description字段
		CvssV2:       cvssV2Str, // 将cvssV2Str赋值给当前对象的CvssV2字段
		CvssV3:       cvssV3Str, // 将cvssV3Str赋值给当前对象的CvssV3字段
	}
}

// TableName returns the table which all db.VulnerabilityMetadata model instances are stored into.
func (VulnerabilityMetadataModel) TableName() string {
	return VulnerabilityMetadataTableName // 返回db.VulnerabilityMetadata model实例存储的表名
}

// Inflate generates a db.VulnerabilityMetadataModel object from the serialized model instance.
func (m *VulnerabilityMetadataModel) Inflate() (v1.VulnerabilityMetadata, error) {
	var links []string // 定义一个字符串数组links
	var cvssV2, cvssV3 *v1.Cvss // 定义v1.Cvss类型的指针cvssV2和cvssV3

	if err := json.Unmarshal([]byte(m.Links), &links); err != nil { // 将m.Links反序列化为links数组
		return v1.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal links (%+v): %w", m.Links, err) // 如果出错，返回错误信息
	}

# 如果CvssV2字段有效，则将其JSON字符串解析为cvssV2结构体
if m.CvssV2.Valid:
    err := json.Unmarshal([]byte(m.CvssV2.String), &cvssV2)
    # 如果解析失败，则返回错误信息
    if err != nil:
        return v1.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvssV2 data (%+v): %w", m.CvssV2, err)

# 如果CvssV3字段有效，则将其JSON字符串解析为cvssV3结构体
if m.CvssV3.Valid:
    err := json.Unmarshal([]byte(m.CvssV3.String), &cvssV3)
    # 如果解析失败，则返回错误信息
    if err != nil:
        return v1.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvssV3 data (%+v): %w", m.CvssV3, err)

# 返回VulnerabilityMetadata结构体，包括ID、RecordSource、Severity、Links和Description字段
return v1.VulnerabilityMetadata{
    ID:           m.ID,
    RecordSource: m.RecordSource,
    Severity:     m.Severity,
    Links:        links,
    Description:  m.Description,
		// 将cvssV2和cvssV3作为键值对存入map中
		CvssV2:       cvssV2,
		CvssV3:       cvssV3,
		// 返回map和空指针
	}, nil
```