# `grype\grype\db\v1\store\model\vulnerability_metadata.go`

```
package model

import (
    "database/sql"  // 导入数据库操作相关的包
    "encoding/json"  // 导入 JSON 编解码相关的包
    "fmt"  // 导入格式化输出相关的包

    v1 "github.com/anchore/grype/grype/db/v1"  // 导入指定路径下的包
)

const (
    VulnerabilityMetadataTableName = "vulnerability_metadata"  // 定义漏洞元数据表的表名常量
)

// VulnerabilityMetadataModel is a struct used to serialize db.VulnerabilityMetadata information into a sqlite3 DB.
type VulnerabilityMetadataModel struct {
    ID           string         `gorm:"primary_key; column:id;"`  // 定义 ID 字段
    RecordSource string         `gorm:"primary_key; column:record_source;"`  // 定义 RecordSource 字段
    Severity     string         `gorm:"column:severity"`  // 定义 Severity 字段
    Links        string         `gorm:"column:links"`  // 定义 Links 字段
    Description  string         `gorm:"column:description"`  // 定义 Description 字段
    CvssV2       sql.NullString `gorm:"column:cvss_v2"`  // 定义 CvssV2 字段
    CvssV3       sql.NullString `gorm:"column:cvss_v3"`  // 定义 CvssV3 字段
}

// NewVulnerabilityMetadataModel generates a new model from a db.VulnerabilityMetadata struct.
func NewVulnerabilityMetadataModel(metadata v1.VulnerabilityMetadata) VulnerabilityMetadataModel {
    links, err := json.Marshal(metadata.Links)  // 将 metadata.Links 转换为 JSON 字符串
    if err != nil {
        // TODO: just no
        panic(err)  // 如果出现错误，触发 panic
    }

    var cvssV2Str sql.NullString  // 定义一个 sql.NullString 类型的变量
    if metadata.CvssV2 != nil {
        cvssV2, err := json.Marshal(*metadata.CvssV2)  // 将 metadata.CvssV2 转换为 JSON 字符串
        if err != nil {
            // TODO: just no
            panic(err)  // 如果出现错误，触发 panic
        }
        cvssV2Str.String = string(cvssV2)  // 将 JSON 字符串赋值给 cvssV2Str.String
        cvssV2Str.Valid = true  // 设置 cvssV2Str 为有效值
    }

    var cvssV3Str sql.NullString  // 定义一个 sql.NullString 类型的变量
    if metadata.CvssV3 != nil {
        cvssV3, err := json.Marshal(*metadata.CvssV3)  // 将 metadata.CvssV3 转换为 JSON 字符串
        if err != nil {
            // TODO: just no
            panic(err)  // 如果出现错误，触发 panic
        }
        cvssV3Str.String = string(cvssV3)  // 将 JSON 字符串赋值给 cvssV3Str.String
        cvssV3Str.Valid = true  // 设置 cvssV3Str 为有效值
    }

    return VulnerabilityMetadataModel{  // 返回一个 VulnerabilityMetadataModel 结构体
        ID:           metadata.ID,  // 设置 ID 字段的值
        RecordSource: metadata.RecordSource,  // 设置 RecordSource 字段的值
        Severity:     metadata.Severity,  // 设置 Severity 字段的值
        Links:        string(links),  // 设置 Links 字段的值
        Description:  metadata.Description,  // 设置 Description 字段的值
        CvssV2:       cvssV2Str,  // 设置 CvssV2 字段的值
        CvssV3:       cvssV3Str,  // 设置 CvssV3 字段的值
    }
}
// TableName返回存储所有db.VulnerabilityMetadata模型实例的表。
func (VulnerabilityMetadataModel) TableName() string {
    return VulnerabilityMetadataTableName
}

// Inflate从序列化的模型实例生成db.VulnerabilityMetadataModel对象。
func (m *VulnerabilityMetadataModel) Inflate() (v1.VulnerabilityMetadata, error) {
    var links []string
    var cvssV2, cvssV3 *v1.Cvss

    // 如果无法解析链接，则返回错误
    if err := json.Unmarshal([]byte(m.Links), &links); err != nil {
        return v1.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal links (%+v): %w", m.Links, err)
    }

    // 如果CvssV2有效，则解析CvssV2数据
    if m.CvssV2.Valid {
        err := json.Unmarshal([]byte(m.CvssV2.String), &cvssV2)
        if err != nil {
            return v1.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvssV2 data (%+v): %w", m.CvssV2, err)
        }
    }

    // 如果CvssV3有效，则解析CvssV3数据
    if m.CvssV3.Valid {
        err := json.Unmarshal([]byte(m.CvssV3.String), &cvssV3)
        if err != nil {
            return v1.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvssV3 data (%+v): %w", m.CvssV3, err)
        }
    }

    // 返回VulnerabilityMetadata对象和nil错误
    return v1.VulnerabilityMetadata{
        ID:           m.ID,
        RecordSource: m.RecordSource,
        Severity:     m.Severity,
        Links:        links,
        Description:  m.Description,
        CvssV2:       cvssV2,
        CvssV3:       cvssV3,
    }, nil
}
```