# `grype\grype\db\v2\store\model\vulnerability_metadata.go`

```
package model

import (
	"database/sql"  // 导入数据库操作相关的包
	"encoding/json" // 导入 JSON 编解码相关的包
	"fmt"           // 导入格式化输出相关的包

	v2 "github.com/anchore/grype/grype/db/v2" // 导入指定路径的包，并重命名为 v2
)

const (
	VulnerabilityMetadataTableName = "vulnerability_metadata" // 定义常量，表示漏洞元数据表的表名
)

// VulnerabilityMetadataModel is a struct used to serialize db.VulnerabilityMetadata information into a sqlite3 DB.
type VulnerabilityMetadataModel struct {
	ID           string         `gorm:"primary_key; column:id;"` // 定义结构体字段 ID，表示主键
	RecordSource string         `gorm:"primary_key; column:record_source;"` // 定义结构体字段 RecordSource，表示主键
	Severity     string         `gorm:"column:severity"` // 定义结构体字段 Severity，表示漏洞严重程度
	Links        string         `gorm:"column:links"` // 定义结构体字段 Links，表示漏洞相关链接
```

// Description 是漏洞描述的字段
Description  string         `gorm:"column:description"`
// CvssV2 是 CVSS V2 的字段，使用 sql.NullString 类型来处理可能为空的情况
CvssV2       sql.NullString `gorm:"column:cvss_v2"`
// CvssV3 是 CVSS V3 的字段，使用 sql.NullString 类型来处理可能为空的情况
CvssV3       sql.NullString `gorm:"column:cvss_v3"`
}

// NewVulnerabilityMetadataModel 从 db.VulnerabilityMetadata 结构生成一个新的模型
func NewVulnerabilityMetadataModel(metadata v2.VulnerabilityMetadata) VulnerabilityMetadataModel {
	// 将 metadata.Links 转换为 JSON 字符串
	links, err := json.Marshal(metadata.Links)
	if err != nil {
		// 如果转换出错，抛出异常
		panic(err)
	}

	// 处理 CVSS V2 字段
	var cvssV2Str sql.NullString
	if metadata.CvssV2 != nil {
		// 将 metadata.CvssV2 转换为 JSON 字符串
		cvssV2, err := json.Marshal(*metadata.CvssV2)
		if err != nil {
			// 如果转换出错，抛出异常
			panic(err)
		}
	// 将cvssV2转换为字符串并赋值给cvssV2Str，设置Valid为true
	cvssV2Str.String = string(cvssV2)
	cvssV2Str.Valid = true
	}

	// 定义一个sql.NullString类型的变量cvssV3Str
	var cvssV3Str sql.NullString
	// 如果metadata.CvssV3不为空
	if metadata.CvssV3 != nil {
		// 将metadata.CvssV3转换为JSON格式并赋值给cvssV3，同时处理可能出现的错误
		cvssV3, err := json.Marshal(*metadata.CvssV3)
		if err != nil {
			// 如果出现错误，抛出异常
			// TODO: just no
			panic(err)
		}
		// 将cvssV3转换为字符串并赋值给cvssV3Str，设置Valid为true
		cvssV3Str.String = string(cvssV3)
		cvssV3Str.Valid = true
	}

	// 返回VulnerabilityMetadataModel对象
	return VulnerabilityMetadataModel{
		// 将metadata的ID赋值给ID
		ID:           metadata.ID,
		// 将metadata的RecordSource赋值给RecordSource
		RecordSource: metadata.RecordSource,
		// 将metadata的Severity赋值给Severity
		Severity:     metadata.Severity,
		// 将links转换为字符串并赋值给Links
		Links:        string(links),
// 将 metadata.Description 赋值给 Description 字段
Description:  metadata.Description,
// 将 cvssV2Str 赋值给 CvssV2 字段
CvssV2:       cvssV2Str,
// 将 cvssV3Str 赋值给 CvssV3 字段
CvssV3:       cvssV3Str,
}

// TableName 返回所有 db.VulnerabilityMetadata 模型实例存储的表名
func (VulnerabilityMetadataModel) TableName() string {
	return VulnerabilityMetadataTableName
}

// Inflate 从序列化的模型实例生成一个 db.VulnerabilityMetadataModel 对象
func (m *VulnerabilityMetadataModel) Inflate() (v2.VulnerabilityMetadata, error) {
	var links []string
	var cvssV2, cvssV3 *v2.Cvss

// 将 m.Links 反序列化为 links 切片
	if err := json.Unmarshal([]byte(m.Links), &links); err != nil {
		return v2.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal links (%+v): %w", m.Links, err)
	}
# 如果CvssV2字段有效，则将其字符串解析为cvssV2结构体
if m.CvssV2.Valid:
    err := json.Unmarshal([]byte(m.CvssV2.String), &cvssV2)
    # 如果解析出错，则返回错误信息
    if err != nil:
        return v2.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvssV2 data (%+v): %w", m.CvssV2, err)

# 如果CvssV3字段有效，则将其字符串解析为cvssV3结构体
if m.CvssV3.Valid:
    err := json.Unmarshal([]byte(m.CvssV3.String), &cvssV3)
    # 如果解析出错，则返回错误信息
    if err != nil:
        return v2.VulnerabilityMetadata{}, fmt.Errorf("unable to unmarshal cvssV3 data (%+v): %w", m.CvssV3, err)

# 返回v2.VulnerabilityMetadata结构体，包括ID、RecordSource、Severity、Links和Description字段
return v2.VulnerabilityMetadata{
    ID:           m.ID,
    RecordSource: m.RecordSource,
    Severity:     m.Severity,
    Links:        links,
    Description:  m.Description,
		// 将cvssV2和cvssV3添加到结构体中
		CvssV2:       cvssV2,
		CvssV3:       cvssV3,
	}, nil
	// 返回结构体和空指针
```